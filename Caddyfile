# Caddy 配置文件 - 提示词优化工具
# Caddyfile for Prompt Optimization Tool

# 替换 your-domain.com 为您的实际域名
# Replace your-domain.com with your actual domain

your-domain.com {
    # 反向代理到应用
    reverse_proxy localhost:8092

    # 启用日志记录
    log {
        output file /var/log/caddy/prompt-optimize.log
        format json
        level INFO
    }

    # 启用压缩
    encode gzip zstd

    # 安全头设置
    header {
        # 启用 HSTS
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        
        # 防止 XSS 攻击
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        
        # 内容安全策略
        Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self'"
        
        # 引用策略
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # 隐藏服务器信息
        -Server
    }

    # 静态文件缓存策略
    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # API 请求不缓存
    @api path /api/*
    header @api {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # 健康检查端点
    respond /health 200 {
        body "OK"
    }
}

# 如果需要支持多个域名或子域名，可以添加：
# www.your-domain.com {
#     redir https://your-domain.com{uri}
# }

# 开发环境配置（使用 localhost）
localhost:80, :80 {
    reverse_proxy localhost:8092

    log {
        output stdout
        level DEBUG
    }

    # 开发环境允许更宽松的安全策略
    header {
        Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; connect-src 'self' https: ws: wss:"
    }
}

# HTTPS 重定向配置（生产环境）
http://your-domain.com {
    redir https://your-domain.com{uri}
}